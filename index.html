<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íœ˜ë§¤ì“° DB</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 1em 0;
        }
        main {
            padding: 20px;
        }
        .filter-section {
            margin: 20px 0;
            text-align: center;
        }
        .filter-section select {
            padding: 5px;
            margin-left: 5px;
        }
        #game-details {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        table th {
            background-color: #f2f2f2;
        }
        .export-button {
            margin-top: 20px;
            text-align: center;
        }
        .export-button button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .export-button button:hover {
            background-color: #0056b3;
        }
        .export-button img {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .delete-button {
            padding: 5px 10px;
            background-color: #FF4C4C;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .delete-button:hover {
            background-color: #cc0000;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
    <script defer>
    let gameData = [];
    let userData = [];
    let currentPage = 1;
    let selectedGame = '';
    let selectedUser = '';

    // âœ… APIë¡œ ê²Œì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchGameData(page = 1, pageSize = 1000000) {
        try {
            const response = await fetch(`https://us-central1-record-f420d.cloudfunctions.net/getGameData?page=${page}&pageSize=${pageSize}`);
            const result = await response.json();
            console.log('ê²Œì„ API ì‘ë‹µ:', result);

            if (result.data && Array.isArray(result.data)) {
                gameData = result.data;
                removeDuplicates();
                renderGameDropdown();
                renderFilteredDetails();
            } else {
                console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ê²Œì„ ë°ì´í„° í˜•ì‹ ë°˜í™˜:', result);
            }
        } catch (error) {
            console.error('ê²Œì„ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        }
    }

    // âœ… ì¤‘ë³µ ë°ì´í„° ì œê±°
    function removeDuplicates() {
        const uniqueData = [];
        const seen = new Set();

        for (let i = gameData.length - 1; i >= 0; i--) {
            const { name, score, elapsedTime } = gameData[i];
            const identifier = `${name}-${score}-${elapsedTime}`;
            if (!seen.has(identifier)) {
                seen.add(identifier);
                uniqueData.unshift(gameData[i]);
            }
        }

        gameData = uniqueData;
    }

    // âœ… APIë¡œ ì‚¬ìš©ì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchUserData(page = 1, pageSize = 1000000) {
        try {
            const response = await fetch(`https://us-central1-record-f420d.cloudfunctions.net/getUserData?page=${page}&pageSize=${pageSize}`);
            const result = await response.json();
            console.log('ì‚¬ìš©ì API ì‘ë‹µ:', result);

            if (result.data && Array.isArray(result.data)) {
                userData = result.data;
                renderUserDropdown();
                renderFilteredDetails();
            } else {
                console.warn('ì˜ˆìƒì¹˜ ëª»í•œ ì‚¬ìš©ì ë°ì´í„° í˜•ì‹ ë°˜í™˜:', result);
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        }
    }

    // âœ… ê²Œì„ ë“œë¡­ë‹¤ìš´ ë Œë”ë§
    function renderGameDropdown() {
        const gameDropdown = document.getElementById('game-dropdown');
        const uniqueGames = [...new Set(gameData.map(item => item.game))];
        gameDropdown.innerHTML = '<option value="">ëª¨ë“  ê²Œì„</option>';
        uniqueGames.forEach(game => {
            const option = document.createElement('option');
            option.value = game;
            option.textContent = game;
            gameDropdown.appendChild(option);
        });
    }

    // âœ… ê²Œì„ ì„ íƒ í•¸ë“¤ëŸ¬ (ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ì¶”ê°€)
    function handleGameChange() {
        selectedGame = document.getElementById('game-dropdown').value;
        selectedUser = ''; // ì‚¬ìš©ì ì„ íƒ ì´ˆê¸°í™”
        document.getElementById('user-dropdown').value = ''; // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        renderFilteredDetails();
    }


    // âœ… ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ë Œë”ë§
    function renderUserDropdown() {
        const userDropdown = document.getElementById('user-dropdown');
        const uniqueUsers = [...new Set(userData.map(item => item.name))].sort(); // ì‚¬ì „ì‹ ë°°ì—´
        userDropdown.innerHTML = '<option value="">ëª¨ë“  ì‚¬ìš©ì</option>';
        uniqueUsers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            userDropdown.appendChild(option);
        });
    }

    // âœ… ì‚¬ìš©ì ì„ íƒ í•¸ë“¤ëŸ¬ (ê²Œì„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™” ì¶”ê°€)
    function handleUserChange() {
        selectedUser = document.getElementById('user-dropdown').value;
        selectedGame = ''; // ê²Œì„ ì„ íƒ ì´ˆê¸°í™”
        document.getElementById('game-dropdown').value = ''; // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        renderFilteredDetails();
    }

    // âœ… í†µí•© í•„í„°ë§ ë° ë Œë”ë§ í•¨ìˆ˜
    function renderFilteredDetails() {
        let filteredData = gameData;

        if (selectedGame) {
            filteredData = filteredData.filter(item => item.game === selectedGame);
        }
        if (selectedUser) {
            filteredData = filteredData.filter(item => item.name === selectedUser);
        }

        const tbody = document.getElementById('data-body');
        tbody.innerHTML = '';
        filteredData.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.game}</td>
                <td>${item.name}</td>
                <td>${item.score}</td>
                <td>${item.elapsedTime}</td>
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td><button class="delete-button" onclick="deleteRow(${index})">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // âœ… ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
    function deleteRow(index) {
        if (confirm('ì„ íƒí•œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            gameData.splice(index, 1);
            renderFilteredDetails();
        }
    }

    // âœ… ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
function exportToExcel() {
    if (!XLSX) {
        console.error('XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    // í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let filteredData = gameData;

    if (selectedGame) {
        filteredData = filteredData.filter(item => item.game === selectedGame);
    }
    if (selectedUser) {
        filteredData = filteredData.filter(item => item.name === selectedUser);
    }

    // ë°ì´í„° ì‹œíŠ¸ ìƒì„±
    const worksheet = XLSX.utils.json_to_sheet(filteredData.map(item => ({
        "ê²Œì„": item.game,
        "ì´ë¦„": item.name,
        "ì ìˆ˜": item.score,
        "ê²½ê³¼ ì‹œê°„": item.elapsedTime,
        "Timestamp": new Date(item.timestamp).toLocaleString()
    })));

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Filtered Data");

    // íŒŒì¼ ì´ë¦„ ë™ì  ì„¤ì •
    const fileName = `data_${selectedGame || 'ëª¨ë“ ê²Œì„'}_${selectedUser || 'ëª¨ë“ ì‚¬ìš©ì'}.xlsx`;
    XLSX.writeFile(workbook, fileName);
}


    window.onload = () => {
        fetchGameData();
        fetchUserData();
    };
</script>
</head>
<body>
    <header>
        <h1>ğŸ® ê²Œì„ ë° ì‚¬ìš©ì ë°ì´í„° ëŒ€ì‹œë³´ë“œ</h1>
    </header>
    <main>
        <section class="filter-section">
            <label for="game-dropdown">ê²Œì„ ì„ íƒ:</label>
            <select id="game-dropdown" onchange="handleGameChange()"></select>

            <label for="user-dropdown">ì‚¬ìš©ì ì„ íƒ:</label>
            <select id="user-dropdown" onchange="handleUserChange()"></select>
        </section>

        <section class="export-button">
            <button onclick="exportToExcel()">
                <img src="https://cdn-icons-png.flaticon.com/512/732/732220.png" alt="Excel Icon"> ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
            </button>
        </section>
        

        <section id="game-details">
            <h2>ë°ì´í„° ìƒì„¸ ì •ë³´</h2>
            <table>
                <thead>
                    <tr>
                        <th>ê²Œì„</th>
                        <th>ì´ë¦„</th>
                        <th>ì ìˆ˜</th>
                        <th>ê²½ê³¼ ì‹œê°„</th>
                        <th>Timestamp</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>
        </section>
    </main>
    <footer>
        <p>Â© 2024 ê²Œì„ ë° ì‚¬ìš©ì ë°ì´í„° ëŒ€ì‹œë³´ë“œ</p>
    </footer>
</body>
</html>
